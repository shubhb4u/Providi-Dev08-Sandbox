function logError(n){try{console.log("Error: "+n)}catch(n){}}function IndexedDBManager(){var r,f=this,u="storage",n=indexedDB||mozIndexedDB||webkitIndexedDB||msIndexedDB;function s(n,e,i,t,c){var o;e?i(e):r?((o=r.transaction([u],n)).onerror=function(n){t&&t(n)},o=o.objectStore(u),i&&i(o)):setTimeout(function(){(c=c||0)<5&&s(n,e,i,t,c+1)},50)}function a(i,t,c,o,r){s("readwrite",null,function(e){f.getItem(t,c,function(n){n=i(n||{}),f.setItem(t,c,n,o,r,e)},r,e)},r)}f.init=function(e){try{var i=n.open("WalkMeStorage",2);i.onerror=function(n){logError("Error starting cross domain listening")},i.onblocked=function(n){logError("indexedDB open blocked")},i.onsuccess=function(n){r=i.result,e&&e()},i.onupgradeneeded=function(n){(n=n.target.result).objectStoreNames.contains(u)&&n.deleteObjectStore(u),n.createObjectStore(u,{keyPath:"uniqueKey"}).createIndex("guid","guid",{unique:!1})}}catch(n){logError(n)}},f.testConnection=function(n,e){(r?n:e)()},f.setItem=function(e,i,t,c,o,n){s("readwrite",n,function(n){(n=n.put({uniqueKey:e+i,guid:e,key:i,value:t})).onsuccess=function(n){c&&c()},n.onerror=function(n){o&&o()}},o)},f.getItem=function(e,i,t,c,n){s("readwrite",n,function(n){(n=n.get(e+i)).onsuccess=function(n){n=(n=n.target.result)?n.value:void 0,t&&t(n)},n.onerror=function(n){c&&c()}},c)},f.getAll=function(t,c,n){s("readwrite",null,function(n){var e=[],i=n.index("guid"),n=IDBKeyRange.only(t);i.openCursor(n).onsuccess=function(n){(n=n.target.result)?(void 0!==n.value.value&&e.push({key:n.value.key,saveObj:n.value.value}),n.continue()):c&&c(e)}},n)},f.removeItem=function(e,i,t,c){s("readwrite",null,function(n){(n=n.delete(e+i)).onsuccess=function(n){t&&t()},n.onerror=function(n){c&&c()}},c)},f.addToDictionary=function(n,e,i,t,c,o,r){a(function(n){var e=(n.value?JSON.parse(n.value):{})||{};return e[i]=t,n.value=JSON.stringify(e),n},n,e,c,o)},f.removeFromDictionary=function(n,e,i,t,c,o){a(function(n){var e=(n.value?JSON.parse(n.value):{})||{};return delete e[i],n.value=JSON.stringify(e),n},n,e,t,c)},f.addToSet=function(o,r,u,a,d,n){s("readwrite",null,function(c){f.getItem(o,r,function(n){var e=[],i=u.value||[];n&&n.value&&(e=JSON.parse(n.value)||[]);for(var t=0;t<i.length;t++)-1==e.indexOf(i[t])&&e.push(i[t]);u.value=JSON.stringify(e),f.setItem(o,r,u,a,d,c)},d,c)},d)},f.increment=function(i,t,c,o,r,u,n){s("readwrite",n,function(e){f.getItem(i,t,function(n){(n=n||{value:0}).value!==c&&n.value++,n.saveTime=(new Date).getTime(),n.expireSeconds=o,f.setItem(i,t,n,function(){r&&r(n.value)},u,e)},u,e)},u)},f.getOrSetAndGet=function(i,t,c,o,r,u,n){s("readwrite",n,function(e){f.getItem(i,t,function(n){n?r&&r(JSON.parse(n.value)):(n={value:JSON.stringify(c),saveTime:(new Date).getTime(),expireSeconds:o},f.setItem(i,t,n,function(){r&&r(c)},u,e))},u,e)})},f.setDictionary=function(i,n,e,t,c){a(function(n){for(var e in i)"value"!=e&&i.hasOwnProperty(e)&&(n[e]=i[e]);return n},n,e,t,c)},function(){}.apply(null,arguments)}var indexedDb=new IndexedDBManager;function createCallback(e,i){return function(n){sendMessage({num:e,success:i,obj:n})}}function sendMessage(n){postMessage(JSON.stringify(n))}indexedDb.init(function(){sendMessage("ready")}),onmessage=function(n){var e=JSON.parse(n.data),i=e.num,t=e.guid,n=e.action,c=e.obj,o=createCallback(i,!0),r=createCallback(i,!1);switch(n){case"set":!1===c.clearDict?indexedDb.setDictionary(c.value,t,c.key,o,r):indexedDb.setItem(t,c.key,c.value,o,r);break;case"get":indexedDb.getItem(t,c.key,o,r);break;case"all":indexedDb.getAll(t,o,r);break;case"del":indexedDb.removeItem(t,c.key,o,r);break;case"add":indexedDb.addToDictionary(t,c.dict,c.key,c.value,o,r);break;case"addSet":indexedDb.addToSet(t,c.key,c.value,o,r);break;case"rem":indexedDb.removeFromDictionary(t,c.dict,c.key,o,r);break;case"test":indexedDb.testConnection(o,r);break;case"inc":indexedDb.increment(t,c.key,c.lastValue,c.ttl,o,r);break;case"getOrSet":indexedDb.getOrSetAndGet(t,c.key,c.fallbackValue,c.ttl,o,r)}};